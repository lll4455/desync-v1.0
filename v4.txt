local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

-- 创建UI开关
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PositionLockUI"
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 80)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0.5, 0)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.Text = "位置锁定开关"
title.TextColor3 = Color3.new(1, 1, 1)
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.Parent = frame

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(1, -20, 0.4, 0)
toggleButton.Position = UDim2.new(0, 10, 0.5, 10)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
toggleButton.Text = "开启锁定"
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.Gotham
toggleButton.Parent = frame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 8)
buttonCorner.Parent = toggleButton

-- 变量初始化
local isLocked = false
local moveDirection = Vector3.new(0, 0, 0)
local walkSpeed = 16
local predictedPosition = Vector3.new()
local serverPosition = Vector3.new()
local shadowPart = nil
local connectionRefs = {}  -- 存储连接引用，避免重复连接

-- 输入处理（全局，只连接一次）
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.W then moveDirection = moveDirection + Vector3.new(0, 0, -1) end
    if input.KeyCode == Enum.KeyCode.S then moveDirection = moveDirection + Vector3.new(0, 0, 1) end
    if input.KeyCode == Enum.KeyCode.A then moveDirection = moveDirection + Vector3.new(-1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.D then moveDirection = moveDirection + Vector3.new(1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.Space then  -- 跳跃支持
        local character = LocalPlayer.Character
        if character then
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then humanoid.Jump = true end
        end
    end
    moveDirection = moveDirection.Unit or Vector3.new()
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.W then moveDirection = moveDirection - Vector3.new(0, 0, -1) end
    if input.KeyCode == Enum.KeyCode.S then moveDirection = moveDirection - Vector3.new(0, 0, 1) end
    if input.KeyCode == Enum.KeyCode.A then moveDirection = moveDirection - Vector3.new(-1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.D then moveDirection = moveDirection - Vector3.new(1, 0, 0) end
    moveDirection = (moveDirection.Magnitude > 0) and moveDirection.Unit or Vector3.new()
end)

-- 切换锁定状态
toggleButton.MouseButton1Click:Connect(function()
    isLocked = not isLocked
    local character = LocalPlayer.Character
    if not character then return end
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end

    if isLocked then
        -- 开启锁定：记录服务器位置
        serverPosition = humanoidRootPart.Position
        predictedPosition = serverPosition
        toggleButton.Text = "关闭锁定"
        toggleButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        
        -- 创建影子Part显示服务器位置
        if not shadowPart then
            shadowPart = Instance.new("Part")
            shadowPart.Name = "LockShadow"
            shadowPart.Size = Vector3.new(4, 5, 2)
            shadowPart.Anchored = true
            shadowPart.Transparency = 0.5
            shadowPart.BrickColor = BrickColor.new("Bright red")
            shadowPart.Material = Enum.Material.ForceField
            shadowPart.Parent = Workspace
            shadowPart.CanCollide = false
        end
        shadowPart.Position = serverPosition + Vector3.new(0, 3, 0)
        
        -- 设置网络所有权（减少服务器纠正）
        pcall(function() humanoidRootPart:SetNetworkOwner(LocalPlayer) end)
        
    else
        -- 关闭锁定：恢复正常
        toggleButton.Text = "开启锁定"
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        if shadowPart then
            shadowPart.Position = Vector3.new(0, -1000, 0)
        end
    end
end)

-- 角色加载处理
LocalPlayer.CharacterAdded:Connect(function(character)
    -- 等待关键部件
    local humanoidRootPart = character:WaitForChild("HumanoidRootPart", 5)
    local humanoid = character:WaitForChild("Humanoid", 5)
    if not humanoidRootPart or not humanoid then return end
    
    -- 重置预测位置（重生时锁定失效）
    predictedPosition = humanoidRootPart.Position
    
    -- 清理旧连接
    for _, conn in pairs(connectionRefs) do
        if conn then conn:Disconnect() end
    end
    connectionRefs = {}
    
    -- 核心循环：RenderStepped（视觉更新最平滑）
    connectionRefs.renderStepped = RunService.RenderStepped:Connect(function(deltaTime)
        if not isLocked then return end
        
        local camera = Workspace.CurrentCamera
        if not camera then return end
        
        -- 计算移动向量（基于相机方向）
        local moveVector = (camera.CFrame.LookVector * moveDirection.Z + 
                           camera.CFrame.RightVector * moveDirection.X) * walkSpeed * deltaTime
        
        -- 更新本地预测位置
        predictedPosition = predictedPosition + moveVector
        
        -- 步骤1：先设置视觉位置（自己看到自己在动）
        humanoidRootPart.CFrame = CFrame.new(predictedPosition, predictedPosition + camera.CFrame.LookVector)
        
        -- 步骤2：立即强制拉回服务器位置（别人看到不动）
        humanoidRootPart.Position = serverPosition
        
        -- 更新影子位置
        if shadowPart then
            shadowPart.CFrame = CFrame.new(serverPosition + Vector3.new(0, 3, 0), 
                                         serverPosition + camera.CFrame.LookVector)
        end
    end)
    
    -- 额外：Heartbeat循环强制服务器位置（双重保险）
    connectionRefs.heartbeat = RunService.Heartbeat:Connect(function()
        if not isLocked then return end
        pcall(function()
            humanoidRootPart.Position = serverPosition
            humanoidRootPart.Velocity = Vector3.new(0, 0, 0)  -- 停止物理移动
        end)
    end)
end)

-- 初始角色处理
if LocalPlayer.Character then
    task.spawn(function()
        LocalPlayer.CharacterAdded:Fire(LocalPlayer.Character)
    end)
end

print("位置锁定脚本加载完成！点击按钮开启/关闭锁定")