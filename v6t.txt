local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

-- UI (ä¿æŒåŸæ ·ï¼Œç¾åŒ–ç‰ˆ)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PositionLockUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 90)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(100, 100, 120)
stroke.Thickness = 1
stroke.Parent = frame

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0.45, 0)
title.BackgroundTransparency = 1
title.Text = "ğŸš« æœåŠ¡å™¨ä½ç½®é”å®š (ä¿®å¤ç‰ˆ)"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.Parent = frame

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(1, -24, 0.45, 0)
toggleButton.Position = UDim2.new(0, 12, 0.5, 8)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
toggleButton.Text = "å¼€å¯é”å®š"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.GothamSemibold
toggleButton.Parent = frame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 8)
buttonCorner.Parent = toggleButton

local buttonStroke = Instance.new("UIStroke")
buttonStroke.Color = Color3.fromRGB(200, 50, 50)
buttonStroke.Thickness = 1
buttonStroke.Parent = toggleButton

-- å˜é‡
local isLocked = false
local moveDirection = Vector3.new()
local predictedPosition = Vector3.new()
local serverPosition = Vector3.new()
local shadowPart = nil
local connections = {}
local originalWalkSpeed = 16

-- è¾“å…¥ (å…¨å±€)
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.W then moveDirection = moveDirection + Vector3.new(0, 0, -1) end
    if input.KeyCode == Enum.KeyCode.S then moveDirection = moveDirection + Vector3.new(0, 0, 1) end
    if input.KeyCode == Enum.KeyCode.A then moveDirection = moveDirection + Vector3.new(-1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.D then moveDirection = moveDirection + Vector3.new(1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.Space then
        local char = LocalPlayer.Character
        if char then
            local hum = char:FindFirstChild("Humanoid")
            if hum then hum.Jump = true end
        end
    end
    moveDirection = moveDirection.Unit
end)

UserInputService.InputEnded:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.W then moveDirection = moveDirection - Vector3.new(0, 0, -1) end
    if input.KeyCode == Enum.KeyCode.S then moveDirection = moveDirection - Vector3.new(0, 0, 1) end
    if input.KeyCode == Enum.KeyCode.A then moveDirection = moveDirection - Vector3.new(-1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.D then moveDirection = moveDirection - Vector3.new(1, 0, 0) end
    moveDirection = moveDirection.Magnitude > 0 and moveDirection.Unit or Vector3.new()
end)

-- å¼€å…³
toggleButton.MouseButton1Click:Connect(function()
    isLocked = not isLocked
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    if not root or not hum then return end

    if isLocked then
        serverPosition = root.Position
        predictedPosition = serverPosition
        originalWalkSpeed = hum.WalkSpeed
        toggleButton.Text = "å…³é—­é”å®š"
        toggleButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        buttonStroke.Color = Color3.fromRGB(50, 200, 50)

        -- å½±å­
        if not shadowPart then
            shadowPart = Instance.new("Part")
            shadowPart.Name = "ShadowHRP"
            shadowPart.Size = Vector3.new(4, 6, 2)
            shadowPart.Anchored = true
            shadowPart.CanCollide = false
            shadowPart.Transparency = 0.4
            shadowPart.BrickColor = BrickColor.new("Bright red")
            shadowPart.Material = Enum.Material.Neon
            shadowPart.Parent = Workspace
        end

        -- ã€å…³é”®ä¿®å¤ã€‘ä¸ä½¿ç”¨PlatformStandï¼Œä¸ç”¨BodyVelocity/BodyAngularï¼ˆè¿™äº›é”æœ¬åœ°ç§»åŠ¨ï¼‰
        -- åªç”¨ç½‘ç»œæ‹¥æœ‰ + å¼ºåˆ¶å¾ªç¯

        -- ç½‘ç»œæ‹¥æœ‰ï¼ˆæœåŠ¡å™¨æ— æ³•çº æ­£ï¼‰
        pcall(function()
            root:SetNetworkOwner(LocalPlayer)
            for _, part in pairs(char:GetChildren()) do
                if part:IsA("BasePart") then
                    part:SetNetworkOwner(LocalPlayer)
                end
            end
        end)

        -- è®¾ç½®é«˜WalkSpeedï¼ˆé˜²æ­¢Humanoidå¹²æ‰°ï¼‰
        hum.WalkSpeed = 50

    else
        toggleButton.Text = "å¼€å¯é”å®š"
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        buttonStroke.Color = Color3.fromRGB(200, 50, 50)
        hum.WalkSpeed = originalWalkSpeed
        if shadowPart then
            shadowPart.Position = Vector3.new(0, -1000, 0)
        end
    end
end)

-- è§’è‰²å¤„ç†
LocalPlayer.CharacterAdded:Connect(function(char)
    -- æ¸…ç†
    for _, conn in pairs(connections) do
        conn:Disconnect()
    end
    connections = {}

    char:WaitForChild("HumanoidRootPart", 5)
    char:WaitForChild("Humanoid", 5)

    if isLocked then
        -- é”å®šçŠ¶æ€ä¸‹é‡ç½®ä½ç½®
        task.wait(0.5)
        local root = char:FindFirstChild("HumanoidRootPart")
        if root then
            root.Position = serverPosition
        end
    end

    -- ã€æ ¸å¿ƒè§†è§‰ç§»åŠ¨ã€‘RenderStepped (æ¯å¸§æœ¬åœ°CFrameï¼Œè¶…ä¸æ»‘)
    connections.render = RunService.RenderStepped:Connect(function(dt)
        if not isLocked then return end
        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then return end

        local camera = Workspace.CurrentCamera
        if not camera then return end

        -- è®¡ç®—ç§»åŠ¨
        local camLook = camera.CFrame.LookVector
        local camRight = camera.CFrame.RightVector
        local moveVec = (camLook * moveDirection.Z + camRight * moveDirection.X) * originalWalkSpeed * dt

        predictedPosition = predictedPosition + moveVec

        -- æœ¬åœ°è§†è§‰ï¼šè®¾ç½®CFrameï¼ˆè‡ªå·±çœ‹åˆ°åŠ¨ï¼‰
        root.CFrame = CFrame.new(predictedPosition, predictedPosition + camLook)

        -- å½±å­
        if shadowPart then
            shadowPart.CFrame = CFrame.new(serverPosition + Vector3.new(0, 3, 0), serverPosition + camLook + Vector3.new(0, 3, 0))
        end
    end)

    -- ã€æœåŠ¡å™¨å¼ºåˆ¶1ã€‘Stepped (ç‰©ç†å‰ï¼Œé˜²æ­¢ç§»åŠ¨)
    connections.stepped = RunService.Stepped:Connect(function()
        if not isLocked then return end
        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then return end
        pcall(function()
            root.Position = serverPosition
            root.Velocity = Vector3.new(0, root.Velocity.Y, 0)  -- åªä¿ç•™Yé€Ÿåº¦ï¼ˆè·³è·ƒï¼‰
            root.RotVelocity = Vector3.new(0, 0, 0)
        end)
    end)

    -- ã€æœåŠ¡å™¨å¼ºåˆ¶2ã€‘Heartbeat (ç‰©ç†åï¼Œæœ€ç»ˆæ‹‰å›)
    connections.heartbeat = RunService.Heartbeat:Connect(function()
        if not isLocked then return end
        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then return end
        pcall(function()
            root.Position = serverPosition
        end)
    end)
end)

-- åˆå§‹åŒ–
if LocalPlayer.Character then
    LocalPlayer.CharacterAdded:Fire(LocalPlayer.Character)
end

print("ğŸ”’ ä½ç½®é”å®šä¿®å¤ç‰ˆåŠ è½½ï¼ç°åœ¨è‡ªå·±èƒ½ä¸æ»‘ç§»åŠ¨ï¼ŒæœåŠ¡å™¨æ°¸ä¸åŠ¨ï¼(æ— PlatformStand/BodyVelocity)")