local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer

-- åˆ›å»ºUIå¼€å…³
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PositionLockUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 90)
frame.Position = UDim2.new(0, 10, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(100, 100, 120)
stroke.Thickness = 1
stroke.Parent = frame

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0.45, 0)
title.BackgroundTransparency = 1
title.Text = "ğŸš« æœåŠ¡å™¨ä½ç½®é”å®š"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.Parent = frame

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(1, -24, 0.45, 0)
toggleButton.Position = UDim2.new(0, 12, 0.5, 8)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
toggleButton.Text = "å¼€å¯é”å®š"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.GothamSemibold
toggleButton.Parent = frame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 8)
buttonCorner.Parent = toggleButton

local buttonStroke = Instance.new("UIStroke")
buttonStroke.Color = Color3.fromRGB(200, 50, 50)
buttonStroke.Thickness = 1
buttonStroke.Parent = toggleButton

-- å˜é‡
local isLocked = false
local moveDirection = Vector3.new()
local bodyVelocity = nil
local bodyAngular = nil
local walkSpeed = 18  -- ç•¥å¿«äºé»˜è®¤16
local predictedPosition = Vector3.new()
local serverPosition = Vector3.new()
local shadowPart = nil
local connections = {}

-- å¼ºåˆ¶æ‰€æœ‰éƒ¨ä»¶ç½‘ç»œæ‹¥æœ‰ï¼ˆæœåŠ¡å™¨æ— æ³•çº æ­£ï¼‰
local function setNetworkOwnerRecursive(model)
    for _, obj in pairs(model:GetDescendants()) do
        if obj:IsA("BasePart") then
            pcall(function() obj:SetNetworkOwner(LocalPlayer) end)
        end
    end
end

-- è¾“å…¥å¤„ç†ï¼ˆå…¨å±€ï¼‰
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.W then moveDirection = moveDirection + Vector3.new(0, 0, -1) end
    if input.KeyCode == Enum.KeyCode.S then moveDirection = moveDirection + Vector3.new(0, 0, 1) end
    if input.KeyCode == Enum.KeyCode.A then moveDirection = moveDirection + Vector3.new(-1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.D then moveDirection = moveDirection + Vector3.new(1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.Space then
        -- è·³è·ƒï¼šç›´æ¥è®¾ç½®çŠ¶æ€ï¼ŒæœåŠ¡å™¨çœ‹ä¸åˆ°
        local char = LocalPlayer.Character
        if char then
            local hum = char:FindFirstChild("Humanoid")
            if hum then hum.Jump = true end
        end
    end
    moveDirection = moveDirection.Unit
end)

UserInputService.InputEnded:Connect(function(input, processed)
    if processed then return end
    if input.KeyCode == Enum.KeyCode.W then moveDirection = moveDirection - Vector3.new(0, 0, -1) end
    if input.KeyCode == Enum.KeyCode.S then moveDirection = moveDirection - Vector3.new(0, 0, 1) end
    if input.KeyCode == Enum.KeyCode.A then moveDirection = moveDirection - Vector3.new(-1, 0, 0) end
    if input.KeyCode == Enum.KeyCode.D then moveDirection = moveDirection - Vector3.new(1, 0, 0) end
    moveDirection = moveDirection.Magnitude > 0 and moveDirection.Unit or Vector3.new()
end)

-- å¼€å…³
toggleButton.MouseButton1Click:Connect(function()
    isLocked = not isLocked
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    if isLocked then
        -- å¼€å¯ï¼šè®°å½•æœåŠ¡å™¨ä½ç½®ï¼Œåˆ›å»ºç‰©ç†æ§åˆ¶å™¨
        serverPosition = root.Position
        predictedPosition = serverPosition
        toggleButton.Text = "å…³é—­é”å®š"
        toggleButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        buttonStroke.Color = Color3.fromRGB(50, 200, 50)

        -- å½±å­
        if not shadowPart then
            shadowPart = Instance.new("Part")
            shadowPart.Name = "ShadowHRP"
            shadowPart.Size = Vector3.new(4, 6, 2)
            shadowPart.Anchored = true
            shadowPart.CanCollide = false
            shadowPart.Transparency = 0.4
            shadowPart.BrickColor = BrickColor.new("Bright red")
            shadowPart.Material = Enum.Material.Neon
            shadowPart.Parent = Workspace
        end

        -- å¼ºåˆ¶ç½‘ç»œæ‹¥æœ‰æ‰€æœ‰éƒ¨ä»¶ï¼ˆå…³é”®ï¼æœåŠ¡å™¨æ— æ³•ç‰©ç†çº æ­£ï¼‰
        setNetworkOwnerRecursive(char)

        -- åˆ›å»ºBodyVelocityé”å®šæœåŠ¡å™¨ä½ç½®ï¼ˆæœ€ç¨³å®šå¼ºåˆ¶ï¼‰
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(1e9, 1e9, 1e9)
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.Parent = root

        -- BodyAngularVelocityé”å®šæ—‹è½¬
        bodyAngular = Instance.new("BodyAngularVelocity")
        bodyAngular.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
        bodyAngular.AngularVelocity = Vector3.new(0, 0, 0)
        bodyAngular.Parent = root

        -- HumanoidçŠ¶æ€é”å®š
        local hum = char:FindFirstChild("Humanoid")
        if hum then
            hum.PlatformStand = true  -- ç¦ç”¨é»˜è®¤ç§»åŠ¨
        end

    else
        -- å…³é—­ï¼šæ¸…ç†
        toggleButton.Text = "å¼€å¯é”å®š"
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        buttonStroke.Color = Color3.fromRGB(200, 50, 50)

        if bodyVelocity then bodyVelocity:Destroy() end
        if bodyAngular then bodyAngular:Destroy() end
        if shadowPart then shadowPart.Position = Vector3.new(0, -1000, 0) end

        local hum = char:FindFirstChild("Humanoid")
        if hum then hum.PlatformStand = false end
    end
end)

-- è§’è‰²é‡ç”Ÿå¤„ç†
LocalPlayer.CharacterAdded:Connect(function(char)
    -- æ¸…ç†æ—§è¿æ¥
    for _, conn in pairs(connections) do
        conn:Disconnect()
    end
    connections = {}

    char.ChildAdded:Wait()  -- ç­‰å¾…åŠ è½½
    task.wait(0.1)

    local root = char:WaitForChild("HumanoidRootPart", 5)
    local hum = char:WaitForChild("Humanoid", 5)
    if not root or not hum then return end

    -- å¦‚æœé”å®šï¼Œé‡ç½®
    if isLocked then
        serverPosition = root.Position
        predictedPosition = serverPosition
        setNetworkOwnerRecursive(char)
        -- é‡æ–°åˆ›å»ºBodyVelocityç­‰ï¼ˆåœ¨å¼€å…³é‡Œä¼šå¤„ç†ï¼‰
    end

    -- ã€æ ¸å¿ƒã€‘RenderStepped: æœ¬åœ°è§†è§‰ç§»åŠ¨ï¼ˆæ¯å¸§144+æ¬¡ï¼Œè¶…ä¸æ»‘ï¼‰
    connections.render = RunService.RenderStepped:Connect(function(dt)
        if not isLocked then return end

        local camera = Workspace.CurrentCamera
        if not camera then return end

        -- åŸºäºç›¸æœºè®¡ç®—ç§»åŠ¨å‘é‡
        local camLook = camera.CFrame.LookVector
        local camRight = camera.CFrame.RightVector
        local moveVec = (camLook * moveDirection.Z + camRight * moveDirection.X) * walkSpeed * dt

        -- æ›´æ–°é¢„æµ‹ä½ç½®
        predictedPosition = predictedPosition + moveVec

        -- ã€è§†è§‰ã€‘è®¾ç½®CFrameåˆ°é¢„æµ‹ä½ç½®ï¼ˆè‡ªå·±çœ‹åˆ°ç§»åŠ¨ï¼‰
        root.CFrame = CFrame.new(predictedPosition, predictedPosition + camLook)

        -- ã€å½±å­ã€‘è·ŸéšæœåŠ¡å™¨ä½ç½®ï¼Œä½†é¢å‘ç›¸æœº
        if shadowPart then
            shadowPart.CFrame = CFrame.new(serverPosition + Vector3.new(0, 3, 0), serverPosition + camLook)
        end
    end)

    -- ã€æœåŠ¡å™¨å¼ºåˆ¶ã€‘Stepped: ç‰©ç†+ä½ç½®åŒé‡é”å®šï¼ˆæœåŠ¡å™¨ç‰©ç†æ¨¡æ‹Ÿå‰ï¼‰
    connections.stepped = RunService.Stepped:Connect(function()
        if not isLocked then return end
        pcall(function()
            root.Position = serverPosition  -- ä½ç½®å¼ºåˆ¶
            root.Velocity = Vector3.new(0, 0, 0)  -- é€Ÿåº¦æ¸…é›¶
            root.RotVelocity = Vector3.new(0, 0, 0)
            if bodyVelocity then bodyVelocity.Velocity = Vector3.new(0,0,0) end
        end)
    end)

    -- ã€ä¸‰é‡ä¿é™©ã€‘Heartbeat: é¢å¤–å¼ºåˆ¶ï¼ˆæœåŠ¡å™¨ç‰©ç†åï¼‰
    connections.heartbeat = RunService.Heartbeat:Connect(function()
        if not isLocked then return end
        pcall(function()
            root.Position = serverPosition
        end)
    end)
end)

-- åˆå§‹åŒ–å½“å‰è§’è‰²
if LocalPlayer.Character then
    task.spawn(function()
        LocalPlayer.CharacterAdded:Fire(LocalPlayer.Character)
    end)
end

print("ğŸ”’ è¶…ç¨³å®šæœåŠ¡å™¨ä½ç½®é”å®šåŠ è½½å®Œæˆï¼(ä¸‰é‡å¾ªç¯ + BodyVelocity + NetworkOwner)")
print("ğŸ’¡ å¼€å¯å: è‡ªå·±ä¸æ»‘ç§»åŠ¨ï¼Œåˆ«äººæ°¸ä¸åŠ¨ï¼æ”¯æŒè·³è·ƒ/é¢å‘é¼ æ ‡")